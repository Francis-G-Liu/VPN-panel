# 🤖 AI 调度服务使用指南

## 📋 概述

AI 调度服务负责定期计算所有节点的 AI 评分，用于智能推荐最优节点。

**评分算法：**
- 延迟得分 (40%)
- 负载得分 (30%)
- 稳定性得分 (30%)
- 晚高峰惩罚 (-20 分)

---

## 🚀 快速开始

### 自动启动（推荐）

AI 调度服务已集成到 FastAPI 应用中，启动后端时会自动启动：

```bash
python backend/main.py
```

**输出：**
```
🚀 启动 AI VPN 管理系统...
📦 初始化数据库连接...
🤖 启动 AI 调度服务...
✅ AI 调度服务已启动，每 60 秒更新一次
```

---

### 手动控制

```python
from backend.services import start_scheduler, stop_scheduler, update_scores_now

# 启动调度服务
start_scheduler()

# 立即更新所有节点评分（手动触发）
update_scores_now()

# 停止调度服务
stop_scheduler()
```

---

## 📊 评分算法详解

### 1. 延迟得分 (40%)

**公式：**
```python
score = 100 / (avg_latency + 1)
score = min(100, score * 10)  # 归一化
```

**逻辑：**
- 延迟越低，分数越高
- 10ms 延迟 ≈ 91 分
- 50ms 延迟 ≈ 67 分
- 100ms 延迟 ≈ 50 分

---

### 2. 负载得分 (30%)

**公式：**
```python
score = 100 - (load_factor * 100)
```

**逻辑：**
- 负载系数 0.2 → 80 分
- 负载系数 0.5 → 50 分
- 负载系数 0.8 → 20 分

---

### 3. 稳定性得分 (30%)

**公式：**
```python
score = (1 - avg_packet_loss) * 100
```

**逻辑：**
- 丢包率 0% → 100 分
- 丢包率 5% → 95 分
- 丢包率 10% → 90 分

---

### 4. 晚高峰惩罚 (-20 分)

**检测条件：**
1. 当前时间为 18:00-23:00
2. 最近延迟比历史平均高 50% 以上

**例子：**
- 历史平均延迟: 30ms
- 最近平均延迟: 50ms (> 30 * 1.5)
- 判定：晚高峰拥堵，扣减 20 分

---

## 💡 评分示例

### 示例 1: 优质节点

**数据：**
- 平均延迟: 15ms
- 负载系数: 0.2
- 丢包率: 0%
- 晚高峰: 否

**计算：**
```
延迟得分 = 100 / (15 + 1) * 10 = 62.5 → 62.5
负载得分 = 100 - (0.2 * 100) = 80
稳定性得分 = (1 - 0) * 100 = 100

总分 = 62.5 * 0.4 + 80 * 0.3 + 100 * 0.3
     = 25 + 24 + 30
     = 79 分
```

---

### 示例 2: 拥堵节点

**数据：**
- 平均延迟: 100ms
- 负载系数: 0.7
- 丢包率: 5%
- 晚高峰: 是

**计算：**
```
延迟得分 = 100 / (100 + 1) * 10 = 9.9
负载得分 = 100 - (0.7 * 100) = 30
稳定性得分 = (1 - 0.05) * 100 = 95

总分 = 9.9 * 0.4 + 30 * 0.3 + 95 * 0.3
     = 3.96 + 9 + 28.5
     = 41.46
     
晚高峰惩罚 -20
最终得分 = 41.46 - 20 = 21.46 分
```

---

## 🔧 自定义配置

### 调整更新间隔

默认每 60 秒更新一次，可以修改：

```python
from backend.services.scheduler import AISchedulerService

# 每 30 秒更新一次
scheduler = AISchedulerService(interval_seconds=30)
scheduler.start()
```

---

### 调整历史数据窗口

默认取最近 5 分钟的数据，可以调整：

```python
# 在 scheduler.py 中修改
def get_recent_metrics(self, session, node_id, minutes=10):  # 改为 10 分钟
    ...
```

---

### 调整权重

在 `calculate_node_score()` 中修改权重：

```python
total_score = (
    latency_score * 0.5 +    # 延迟权重改为 50%
    load_score * 0.3 +       # 负载权重 30%
    stability_score * 0.2    # 稳定性权重改为 20%
)
```

---

## 📈 监控与日志

### 查看调度日志

```bash
# 查看后端日志
tail -f backend.log | grep "AI 调度"
```

**示例输出：**
```
============================================================
📊 开始更新节点 AI 评分...
📌 找到 5 个活跃节点
  ✅ HK-Node-01: 85.23/100
  ✅ US-Node-02: 72.45/100
  🕐 SG-Node-03 检测到晚高峰拥堵，扣减 20 分
  ✅ SG-Node-03: 45.67/100
  ✅ JP-Node-04: 90.12/100
  ✅ EU-Node-05: 68.34/100
✅ 成功更新 5/5 个节点的评分
============================================================
```

---

## 🧪 测试

### 手动触发更新

```python
from backend.services import update_scores_now

# 立即执行一次评分更新
update_scores_now()
```

### 验证评分

```bash
# 查看节点评分
curl http://localhost:8000/api/v1/client/nodes \
  -H "Authorization: Bearer your-token"
```

**响应：**
```json
[
  {
    "id": 1,
    "name": "HK-Node-01",
    "ai_score": 85.23,
    "link": "vless://..."
  }
]
```

---

## 🔍 故障排查

### 问题：节点评分不更新

**检查：**
1. 调度服务是否启动
2. 节点是否有监控数据
3. 数据库连接是否正常

**解决：**
```python
# 手动触发更新查看错误
update_scores_now()
```

---

### 问题：所有节点评分都很低

**原因：**
- 监控数据质量差
- 网络延迟普遍较高
- 负载系数设置不合理

**解决：**
1. 检查节点监控 Agent 是否正常运行
2. 调整评分权重
3. 检查延迟测试目标是否合理

---

## 💡 最佳实践

1. **定期检查日志**：确保调度服务正常运行
2. **监控评分分布**：避免所有节点评分过低或过高
3. **调整权重**：根据实际业务需求调整评分权重
4. **数据清理**：定期清理过期的监控数据

---

**AI 调度服务已就绪，开始智能推荐最优节点！** 🎉
